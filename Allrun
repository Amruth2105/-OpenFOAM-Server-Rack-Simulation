#!/bin/bash
#------------------------------------------------------------------------------
# Allrun script for Server Rack Thermal Simulation
#------------------------------------------------------------------------------

cd "${0%/*}" || exit 1

# Source OpenFOAM run functions
. ${WM_PROJECT_DIR:?}/bin/tools/RunFunctions

# Clean previous runs
./Allclean

echo "=========================================="
echo "Server Rack Thermal Analysis - OpenFOAM 12"
echo "=========================================="

# Step 1: Create base mesh
echo ""
echo "Step 1: Creating base mesh with blockMesh..."
runApplication blockMesh

# Step 2: Check mesh quality
echo ""
echo "Step 2: Checking mesh quality..."
runApplication checkMesh

# Optional: Run snappyHexMesh for detailed rack geometry
# Uncomment to enable:
# runApplication snappyHexMesh -overwrite

# Step 3: Initialise temperature field (hot zone in server rack region)
echo ""
echo "Step 3: Initialising fields with setFields..."
cp -r 0 0.orig
runApplication setFields

# Step 4: Run solver
echo ""
echo "Step 4: Running foamRun (steady-state buoyant flow)..."
echo "This may take several minutes..."
runApplication foamRun

# Step 5: Post-processing
echo ""
echo "Step 5: Post-processing..."
runApplication -s yPlus postProcess -func yPlus -latestTime
runApplication -s wallHeatFlux postProcess -func wallHeatFlux -latestTime

echo ""
echo "=========================================="
echo "Simulation Complete!"
echo "=========================================="
echo ""
echo "Results saved in latest time directory"
echo "Open ParaView to visualize:"
echo "  paraFoam"
echo ""
echo "Key outputs:"
echo "  - Temperature distribution (T)"
echo "  - Velocity field (U)"
echo "  - Pressure field (p, p_rgh)"
echo "  - Wall heat flux"
echo ""
